<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Control de Asistencia</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    body { font-family: sans-serif; padding: 2rem; text-align: center; }
    video { border: 1px solid #ccc; width: 100%; max-width: 480px; }
    #status, #log { margin-top: 1rem; font-size: 1.2rem; }
  </style>
</head>
<body>
  <h1>Control de Asistencia</h1>
  <video id="video" autoplay muted playsinline></video>
  <div id="status">Cargando...</div>
  <div id="log"></div>

  <script>
    // üö® Reemplaz√° con tus datos reales
    const SUPABASE_URL = 'https://fkszclyttkrmodptcmao.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZrc3pjbHl0dGtybW9kcHRjbWFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQzMTIzODgsImV4cCI6MjA1OTg4ODM4OH0.OpHn_trW0nhdmN-KRE0SANdULybRF3jSgyGzQ4vihTM';
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const video = document.getElementById('video');
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');

    const empleados = [
      { nombre: 'Joa P√©rez', turno: 'ma√±ana' },
      { nombre: 'Agustina Chiodini', turno: 'tarde' }
    ];

    let puedeRegistrar = true;

    async function obtenerTipoEvento(nombre) {
      const desdeHoy = new Date();
      desdeHoy.setHours(0, 0, 0, 0);

      const { data, error } = await client
        .from('registros')
        .select('id')
        .eq('nombre', nombre)
        .gte('fecha_hora', desdeHoy.toISOString());

      if (error) {
        console.warn('Error al verificar registros anteriores:', error);
        return 'entrada';
      }

      return (data.length === 0) ? 'entrada' : 'salida';
    }

    async function registrar(nombre, turno) {
      if (!puedeRegistrar) return;

      puedeRegistrar = false;
      setTimeout(() => { puedeRegistrar = true }, 10000); // espera 10 segundos

      const tipo_evento = await obtenerTipoEvento(nombre);

      const hora = new Date().getHours();
      const estado = (turno === 'ma√±ana' && hora < 14) || (turno === 'tarde' && hora >= 14)
        ? 'en turno'
        : 'fuera de turno';

      const { error } = await client
        .from('registros')
        .insert([{ nombre, estado_turno: estado, tipo_evento }]);

      if (error) {
        statusEl.innerText = '‚ùå Error al guardar';
        console.error(error);
      } else {
        statusEl.innerText = `‚úÖ ${nombre} registrado (${estado})`;
        logEl.innerText = `${nombre} - ${tipo_evento.toUpperCase()} (${estado}) - ${new Date().toLocaleTimeString()}`;
      }
    }

    // Configurar MediaPipe
    const faceDetection = new FaceDetection({
      locateFile: (file) =>
        `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`,
    });

    faceDetection.setOptions({
      model: 'short',
      minDetectionConfidence: 0.7,
    });

    faceDetection.onResults((results) => {
      if (results.detections.length > 0) {
        // Por ahora, detectamos siempre a "Joa P√©rez"
        registrar('Joa P√©rez', 'ma√±ana');
      }
    });

    const camera = new Camera(video, {
      onFrame: async () => {
        await faceDetection.send({ image: video });
      },
      width: 480,
      height: 360,
    });

    camera.start();
    statusEl.innerText = 'Esperando detecci√≥n...';
  </script>
</body>
</html>
